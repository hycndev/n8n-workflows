{
  "name": "Monitoring (Playwright MCP) - screenshot",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 15
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -912,
        -32
      ],
      "id": "f3ce4633-08fd-4454-ae22-484ee9269c13",
      "name": "Every 15 Minutes"
    },
    {
      "parameters": {
        "jsCode": "// ëª¨ë‹ˆí„°ë§ ì„¤ì • (schedule íŠ¸ë¦¬ê±° timestamp ì‚¬ìš©)\nconst triggerTimestamp = $input.first().json.timestamp;\nconst now = new Date(triggerTimestamp);\n// í•œêµ­ì‹œê°„ìœ¼ë¡œ ë³€í™˜ (UTC+9)\nconst kstTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));\nconst timestamp = kstTime.toISOString();\nconst checkId = `${$execution.id}-${kstTime.getTime()}`;\nconst screenshotFilename = `health-check_${kstTime.toISOString().replace(/[:.]/g, '-')}.png`;\n\nconst config = {\n  url: 'https://www.google.com',\n  checkId: checkId,\n  timestamp: timestamp,\n  targetName: 'localhost-3000',\n  screenshotFilename: screenshotFilename\n};\n\nreturn {\n  json: config\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -736,
        -32
      ],
      "id": "0b9c32dd-801f-48ae-9c13-49df76df5f9a",
      "name": "Initialize Config"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "chat-input-id",
              "name": "chatInput",
              "value": "=URL: {{ $json.url }}\nìŠ¤í¬ë¦°ìƒ· íŒŒì¼ëª…: {{ $json.screenshotFilename }}\ní—¬ìŠ¤ ì²´í¬ ì‹œì‘.",
              "type": "string"
            },
            {
              "id": "330b6a2e-b02c-4756-8937-b73c78486638",
              "name": "sessionId",
              "value": "={{ $json.checkId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -560,
        -32
      ],
      "id": "6e4e3fe1-f981-40a9-86d1-e855f580063c",
      "name": "Prepare Agent Input"
    },
    {
      "parameters": {
        "options": {
          "systemMessage": "ì›¹ì‚¬ì´íŠ¸ í—¬ìŠ¤ ì²´í¬:\n1. browser_navigate (URL ì ‘ì†)\n2. browser_evaluateë¡œ ì„±ëŠ¥ ì¸¡ì •: () => ({timing: window.performance.timing})\n3. browser_take_screenshot (fullPage: true)\n4. browser_console_messages\nê° ë„êµ¬ 1ë²ˆì”© ì‹¤í–‰ í›„ ì¢…ë£Œ.",
          "maxIterations": 6,
          "returnIntermediateSteps": true
        }
      },
      "id": "d9e11ec7-c93a-4b92-8727-35e84007b2a0",
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        -384,
        -32
      ],
      "typeVersion": 1.8
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -464,
        224
      ],
      "id": "55af7199-9ab2-486f-a3df-c7b5837f6692",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "5rRAhN5ByIhyqQ88",
          "name": "Google Gemini(PaLM) Api account 2"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -320,
        224
      ],
      "id": "dc195e54-c848-4389-8ee3-62f5f1c51786",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "fwYQR53oadRtTScA",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// AI Agent ì‘ë‹µì—ì„œ ëª¨ë‹ˆí„°ë§ ê²°ê³¼ ë° ìŠ¤í¬ë¦°ìƒ· ì¶”ì¶œ (ì„±ëŠ¥ ë°ì´í„° ìˆ˜ì • ë²„ì „)\nconst config = $('Initialize Config').first().json;\nconst agentOutput = $json;\n\nconsole.log('=== AI Agent ì‘ë‹µ ì²˜ë¦¬ ì‹œì‘ ===');\n\nlet performanceData = null;\nlet consoleData = null;\nlet screenshotBase64 = null;\nlet screenshotBuffer = null;\nlet navigationSuccess = false;\nlet pageTitle = '';\n\n// 1. Outputì—ì„œ ì„±ëŠ¥ ë°ì´í„° ì¶”ì¶œ\ntry {\n  if (agentOutput.output) {\n    let outputData;\n    if (agentOutput.output.includes('```json')) {\n      const jsonMatch = agentOutput.output.match(/```json\\n([\\s\\S]*?)\\n```/);\n      if (jsonMatch) {\n        outputData = JSON.parse(jsonMatch[1]);\n        console.log('âœ“ JSON íŒŒì‹± ì„±ê³µ (ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡)');\n        if (outputData?.performance) {\n          performanceData = outputData.performance;\n          console.log('âœ“ Outputì—ì„œ ì„±ëŠ¥ ë°ì´í„° ì¶”ì¶œ ì„±ê³µ');\n        }\n      }\n    } else {\n      outputData = JSON.parse(agentOutput.output);\n      if (outputData?.performance) performanceData = outputData.performance;\n    }\n    if (outputData?.console_errors) consoleData = outputData.console_errors;\n  }\n} catch (e) {\n  console.error('Output íŒŒì‹± ì‹¤íŒ¨:', e.message);\n}\n\n// 2. intermediateSteps ì²˜ë¦¬\nconst steps = agentOutput.intermediateSteps || [];\nconsole.log(`ì´ ${steps.length}ê°œì˜ steps`);\n\nfor (let i = 0; i < steps.length; i++) {\n  const step = steps[i];\n  const tool = step.action?.tool;\n  const observation = step.observation;\n  \n  console.log(`Step ${i}: ${tool}`);\n  \n  if (tool === 'browser_navigate') {\n    navigationSuccess = observation && observation.includes('Page URL');\n    const titleMatch = observation.match(/Page Title: ([^\\n\\r]+)/);\n    if (titleMatch) {\n      let rawTitle = titleMatch[1].trim();\n      // Page Snapshotì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì²« ì¤„ë§Œ ì¶”ì¶œ\n      if (rawTitle.includes('- Page Snapshot:')) {\n        pageTitle = rawTitle.split(/\\\\n|- Page Snapshot:/)[0].trim();\n      } else {\n        pageTitle = rawTitle;\n      }\n      console.log('âœ“ í˜ì´ì§€ ì œëª© ì¶”ì¶œ:', pageTitle);\n    }\n  } \n  else if (tool === 'browser_evaluate') {\n    // performanceDataê°€ ì´ë¯¸ ìˆìœ¼ë©´ ê±´ë„ˆë›°ê¸°\n    if (performanceData) {\n      console.log('âš  ì„±ëŠ¥ ë°ì´í„° ì´ë¯¸ ì¡´ì¬, ê±´ë„ˆë›°ê¸°');\n      continue;\n    }\n    \n    // ê°œì„ ëœ ì„±ëŠ¥ ë°ì´í„° íŒŒì‹±\n    console.log('=== ì„±ëŠ¥ ë°ì´í„° ì¶”ì¶œ ì‹œë„ ===');\n    \n    try {\n      // observationì´ JSON ë°°ì—´ í˜•íƒœì¸ ê²½ìš°\n      if (typeof observation === 'string' && observation.trim().startsWith('[')) {\n        const observationArray = JSON.parse(observation);\n        console.log('âœ“ observationì„ JSON ë°°ì—´ë¡œ íŒŒì‹± ì„±ê³µ');\n        \n        // text íƒ€ì…ì—ì„œ ë°ì´í„° ì°¾ê¸°\n        for (const item of observationArray) {\n          if (item.type === 'text' && item.text) {\n            console.log('text í•­ëª© ë°œê²¬, ê¸¸ì´:', item.text.length);\n            \n            // ### Result ë‹¤ìŒì˜ JSON ì¶”ì¶œ (balanced brace matching)\n            let jsonStr = null;\n            const resultIndex = item.text.indexOf('### Result');\n            if (resultIndex !== -1) {\n              const startIdx = item.text.indexOf('{', resultIndex);\n              if (startIdx !== -1) {\n                let braceCount = 0;\n                let endIdx = -1;\n                \n                for (let j = startIdx; j < item.text.length; j++) {\n                  if (item.text[j] === '{') braceCount++;\n                  else if (item.text[j] === '}') {\n                    braceCount--;\n                    if (braceCount === 0) {\n                      endIdx = j;\n                      break;\n                    }\n                  }\n                }\n                \n                if (endIdx !== -1) {\n                  jsonStr = item.text.substring(startIdx, endIdx + 1);\n                  console.log('âœ“ Balanced brace matchingìœ¼ë¡œ JSON ì¶”ì¶œ ì„±ê³µ');\n                } else {\n                  console.error('âŒ Balanced brace matching ì‹¤íŒ¨: ë‹«ëŠ” braceë¥¼ ì°¾ì§€ ëª»í•¨');\n                }\n              } else {\n                console.error('âŒ JSON ì‹œì‘ { ë¥¼ ì°¾ì§€ ëª»í•¨');\n              }\n            } else {\n              console.error('âŒ ### Resultë¥¼ ì°¾ì§€ ëª»í•¨');\n            }\n            \n            const resultMatch = jsonStr ? [null, jsonStr] : null;\n            if (resultMatch) {\n              console.log('JSON ë¬¸ìì—´ ì¶”ì¶œ, ê¸¸ì´:', jsonStr.length);\n              console.log('JSON ì‹œì‘ ë¶€ë¶„:', jsonStr.substring(0, 200));\n              \n              try {\n                performanceData = JSON.parse(jsonStr);\n                console.log('âœ“âœ“âœ“ ì„±ëŠ¥ ë°ì´í„° íŒŒì‹± ì„±ê³µ!');\n                console.log('timing ë°ì´í„°:', performanceData.timing ? 'ìˆìŒ' : 'ì—†ìŒ');\n                if (performanceData.timing) {\n                  console.log('- navigationStart:', performanceData.timing.navigationStart);\n                  console.log('- loadEventEnd:', performanceData.timing.loadEventEnd);\n                  console.log('- domContentLoadedEventEnd:', performanceData.timing.domContentLoadedEventEnd);\n                }\n                break;\n              } catch (jsonError) {\n                console.error('âŒ JSON íŒŒì‹± ì‹¤íŒ¨:', jsonError.message);\n                console.error('JSON ë¬¸ìì—´ ìƒ˜í”Œ (ì• 500ì):', jsonStr.substring(0, 500));\n                console.error('JSON ë¬¸ìì—´ ìƒ˜í”Œ (ë’¤ 200ì):', jsonStr.substring(Math.max(0, jsonStr.length - 200)));\n                \n                // ëŒ€ì•ˆ: ì¤„ë°”ê¿ˆ ì œê±°í•˜ê³  ë‹¤ì‹œ ì‹œë„\n                try {\n                  const cleanedJson = jsonStr.replace(/\\n/g, '');\n                  performanceData = JSON.parse(cleanedJson);\n                  console.log('âœ“ ì¤„ë°”ê¿ˆ ì œê±° í›„ íŒŒì‹± ì„±ê³µ');\n                } catch (e2) {\n                  console.error('âŒ ì¬ì‹œë„ ì‹¤íŒ¨:', e2.message);\n                }\n              }\n            } else {\n              console.warn('âš  ### Result\\\\n{...} íŒ¨í„´ ë§¤ì¹­ ì‹¤íŒ¨');\n              console.log('item.text ë‚´ìš© (ì²˜ìŒ 500ì):', item.text.substring(0, 500));\n            }\n          }\n        }\n      } \n      // observationì´ ì¼ë°˜ ë¬¸ìì—´ì¸ ê²½ìš° (ê¸°ì¡´ ë°©ì‹)\n      else if (typeof observation === 'string') {\n        console.log('observationì„ ì¼ë°˜ ë¬¸ìì—´ë¡œ ì²˜ë¦¬');\n        const jsonMatch = observation.match(/### Result\\n(\\{[\\s\\S]*?\\})/);\n        if (jsonMatch) {\n          performanceData = JSON.parse(jsonMatch[1]);\n          console.log('âœ“ ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ì„±ëŠ¥ ë°ì´í„° ì¶”ì¶œ ì„±ê³µ');\n        }\n      }\n      \n      if (!performanceData) {\n        console.warn('âš âš âš  ì„±ëŠ¥ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!');\n      }\n    } catch (e) {\n      console.error('âŒ ì„±ëŠ¥ ë°ì´í„° ì¶”ì¶œ ì‹¤íŒ¨:', e.message);\n      console.error('Stack:', e.stack);\n    }\n  } \n  else if (tool === 'browser_console_messages' && !consoleData) {\n    consoleData = observation;\n  } \n  else if (tool === 'browser_take_screenshot') {\n    console.log('=== ìŠ¤í¬ë¦°ìƒ· ì¶”ì¶œ ì‹œë„ ===');\n    console.log('observation íƒ€ì…:', typeof observation);\n    console.log('observation ê¸¸ì´:', observation?.length);\n    \n    if (!observation) {\n      console.error('âŒ observationì´ ì—†ìŒ');\n      continue;\n    }\n    \n    if (typeof observation !== 'string') {\n      console.error('âŒ observationì´ ë¬¸ìì—´ì´ ì•„ë‹˜:', typeof observation);\n      console.log('observation ë‚´ìš©:', JSON.stringify(observation).substring(0, 200));\n      continue;\n    }\n    \n    console.log('observation ì‹œì‘ 200ì:', observation.substring(0, 200));\n    \n    try {\n      const trimmed = observation.trim();\n      console.log('trimmed ì‹œì‘ ë¬¸ì:', trimmed.substring(0, 10));\n      console.log('[ ë¡œ ì‹œì‘:', trimmed.startsWith('['));\n      \n      if (trimmed.startsWith('[')) {\n        const observationArray = JSON.parse(trimmed);\n        console.log(`âœ“ ë°°ì—´ íŒŒì‹± ì„±ê³µ (${observationArray.length}ê°œ í•­ëª©)`);\n        \n        for (let i = 0; i < observationArray.length; i++) {\n          const item = observationArray[i];\n          console.log(`  Item ${i}: type=${item.type}, has data=${!!item.data}`);\n          \n          if (item.type === 'image' && item.data) {\n            console.log(`  -> ì´ë¯¸ì§€ ë°ì´í„° íƒ€ì…: ${typeof item.data}`);\n            console.log(`  -> ì´ë¯¸ì§€ ë°ì´í„° ê¸¸ì´: ${item.data.length}`);\n            console.log(`  -> ë°ì´í„° ì‹œì‘: ${item.data.substring(0, 50)}`);\n            \n            if (typeof item.data === 'string' && item.data.length > 0) {\n              screenshotBase64 = item.data;\n              \n              // base64 ë°ì´í„° ê²€ì¦\n              console.log(`  -> Base64 ë°ì´í„° ê²€ì¦ ì‹œì‘`);\n              console.log(`  -> Base64 ê¸¸ì´: ${screenshotBase64.length}`);\n              console.log(`  -> ì‹œì‘ ë¬¸ì: ${screenshotBase64.substring(0, 20)}`);\n              console.log(`  -> iVBORwë¡œ ì‹œì‘ (PNG): ${screenshotBase64.startsWith('iVBORw')}`);\n              \n              // Bufferë¡œ ë³€í™˜\n              try {\n                screenshotBuffer = Buffer.from(screenshotBase64, 'base64');\n                console.log(`âœ“ Buffer ë³€í™˜ ì„±ê³µ: ${screenshotBuffer.length} bytes`);\n                \n                // PNG í—¤ë” ê²€ì¦ (89 50 4E 47)\n                const pngHeader = screenshotBuffer.slice(0, 8);\n                const isPNG = pngHeader[0] === 0x89 && \n                             pngHeader[1] === 0x50 && \n                             pngHeader[2] === 0x4E && \n                             pngHeader[3] === 0x47;\n                \n                console.log(`âœ“ PNG í—¤ë”: ${Array.from(pngHeader.slice(0, 4)).map(b => '0x' + b.toString(16).toUpperCase()).join(' ')}`);\n                console.log(`âœ“ ìœ íš¨í•œ PNG: ${isPNG}`);\n                \n                if (!isPNG) {\n                  console.warn('âš  PNG í—¤ë”ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤!');\n                  console.warn('Base64 ë””ì½”ë”© ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤');\n                }\n                \n                console.log(`âœ“âœ“âœ“ ìŠ¤í¬ë¦°ìƒ· ë°œê²¬! Buffer í¬ê¸°: ${screenshotBuffer.length} bytes`);\n                console.log(`âœ“âœ“âœ“ Bufferê°€ ìœ íš¨í•¨: ${Buffer.isBuffer(screenshotBuffer)}`);\n                break;\n              } catch (bufferError) {\n                console.error('âŒ Buffer ë³€í™˜ ì‹¤íŒ¨:', bufferError.message);\n                screenshotBuffer = null;\n              }\n            } else {\n              console.warn('  -> ë°ì´í„°ê°€ ë¹„ì–´ìˆê±°ë‚˜ ë¬¸ìì—´ì´ ì•„ë‹˜');\n            }\n          }\n        }\n      } else {\n        console.warn('âš  observationì´ [ ë¡œ ì‹œì‘í•˜ì§€ ì•ŠìŒ');\n      }\n    } catch (e) {\n      console.error('âŒ íŒŒì‹± ì—ëŸ¬:', e.message);\n      console.error('Stack:', e.stack);\n    }\n    \n    if (!screenshotBuffer) {\n      console.warn('âš âš âš  ìŠ¤í¬ë¦°ìƒ·ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ!');\n    }\n  }\n}\n\n// ì½˜ì†” ì—ëŸ¬ ì¶”ì¶œ\nconst jsErrors = [];\nif (consoleData && consoleData.includes('[ERROR]')) {\n  const errorLines = consoleData.split('\\n').filter(line => line.includes('[ERROR]'));\n  jsErrors.push(...errorLines.map(line => ({ message: line, type: 'error' })));\n}\n\n// ì„±ëŠ¥ ë°ì´í„° ê³„ì‚°\nlet pageLoadTime = 0;\nlet domContentLoadedTime = 0;\nlet firstContentfulPaint = 0;\nlet ttfb = 0;\n\nconsole.log('=== ì„±ëŠ¥ ë©”íŠ¸ë¦­ ê³„ì‚° ===');\nconsole.log('performanceData:', performanceData ? 'ìˆìŒ' : 'ì—†ìŒ');\n\nif (performanceData?.timing) {\n  const t = performanceData.timing;\n  console.log('Timing ë°ì´í„°:');\n  console.log('- navigationStart:', t.navigationStart);\n  console.log('- loadEventEnd:', t.loadEventEnd);\n  console.log('- domContentLoadedEventEnd:', t.domContentLoadedEventEnd);\n  console.log('- responseStart:', t.responseStart);\n  console.log('- responseEnd:', t.responseEnd);\n  \n  if (t.loadEventEnd && t.navigationStart) {\n    pageLoadTime = t.loadEventEnd - t.navigationStart;\n  }\n  if (t.domContentLoadedEventEnd && t.navigationStart) {\n    domContentLoadedTime = t.domContentLoadedEventEnd - t.navigationStart;\n  }\n  if (t.responseEnd && t.navigationStart) {\n    firstContentfulPaint = t.responseEnd - t.navigationStart;\n  }\n  if (t.responseStart && t.navigationStart) {\n    ttfb = t.responseStart - t.navigationStart;\n  }\n  \n  console.log('ê³„ì‚°ëœ ê°’:');\n  console.log('- pageLoadTime:', pageLoadTime, 'ms');\n  console.log('- domContentLoadedTime:', domContentLoadedTime, 'ms');\n  console.log('- firstContentfulPaint:', firstContentfulPaint, 'ms');\n  console.log('- ttfb:', ttfb, 'ms');\n} else if (performanceData?.navigation) {\n  pageLoadTime = performanceData.navigation.duration || 0;\n  domContentLoadedTime = performanceData.navigation.domContentLoadedEventEnd || 0;\n  console.log('Navigation ë°ì´í„° ì‚¬ìš©:', performanceData.navigation);\n} else {\n  console.warn('âš  ì„±ëŠ¥ ë°ì´í„°ê°€ ì—†ìŒ - ëª¨ë“  ê°’ì´ 0ìœ¼ë¡œ ì„¤ì •ë¨');\n}\n\nconst httpStatusCode = navigationSuccess ? 200 : 500;\n\n// ìƒíƒœ ê²°ì •\nlet status = 'success';\nlet severity = 'low';\n\nif (!navigationSuccess) {\n  status = 'error';\n  severity = 'critical';\n} else if (jsErrors.length >= 5) {\n  status = 'error';\n  severity = 'medium';\n} else if (pageLoadTime > 3000) {\n  status = 'warning';\n  severity = 'medium';\n} else if (jsErrors.length > 0 || pageLoadTime > 2000) {\n  status = 'warning';\n  severity = 'low';\n}\n\n// ê²°ê³¼ ë°ì´í„°\nconst monitoringResult = {\n  check_id: config.checkId,\n  url: config.url,\n  check_timestamp: config.timestamp,\n  status: status,\n  http_status_code: httpStatusCode,\n  page_load_time_ms: pageLoadTime,\n  first_contentful_paint_ms: firstContentfulPaint,\n  dom_content_loaded_ms: domContentLoadedTime,\n  total_resources_loaded: 0,\n  failed_resources_count: 0,\n  javascript_errors: jsErrors,\n  console_errors: jsErrors,\n  network_errors: [],\n  screenshot_path: null,\n  screenshot_size_bytes: screenshotBuffer ? screenshotBuffer.length : 0,\n  page_title: pageTitle,\n  meta_description: '',\n  raw_data: {\n    agent_output: agentOutput,\n    performance: performanceData,\n    console: consoleData\n  }\n};\n\nconsole.log('=== ìµœì¢… ì²˜ë¦¬ ê²°ê³¼ ===');\nconsole.log('URL:', config.url);\nconsole.log('ìƒíƒœ:', status);\nconsole.log('ë¡œë“œ ì‹œê°„:', pageLoadTime, 'ms');\nconsole.log('DOM ë¡œë“œ:', domContentLoadedTime, 'ms');\nconsole.log('FCP:', firstContentfulPaint, 'ms');\nconsole.log('TTFB:', ttfb, 'ms');\nconsole.log('JS ì—ëŸ¬:', jsErrors.length);\nconsole.log('í˜ì´ì§€ ì œëª©:', pageTitle);\nconsole.log('ìŠ¤í¬ë¦°ìƒ·:', screenshotBuffer ? `${screenshotBuffer.length} bytes` : 'ì—†ìŒ');\nconsole.log('========================');\n\nconsole.log('=== ë°”ì´ë„ˆë¦¬ ë°ì´í„° ì¤€ë¹„ ===');\nconsole.log('screenshotBuffer ì¡´ì¬:', !!screenshotBuffer);\nconsole.log('screenshotBuffer íƒ€ì…:', typeof screenshotBuffer);\nconsole.log('Buffer.isBuffer:', screenshotBuffer ? Buffer.isBuffer(screenshotBuffer) : false);\nconsole.log('screenshotBuffer í¬ê¸°:', screenshotBuffer ? screenshotBuffer.length : 0);\n\n// ë°˜í™˜ê°’\nconst result = {\n  json: {\n    config,\n    monitoringResult,\n    summary: {\n      status,\n      severity,\n      timestamp: config.timestamp,\n      url: config.url,\n      pageLoadTime,\n      httpStatusCode,\n      jsErrorCount: jsErrors.length,\n      networkErrorCount: 0,\n      pageTitle\n    },\n    hasScreenshot: !!screenshotBuffer,\n    screenshotBufferSize: screenshotBuffer ? screenshotBuffer.length : 0\n  }\n};\n\n// ë°”ì´ë„ˆë¦¬ ë°ì´í„° ì¶”ê°€ (n8n í˜•ì‹)\nif (screenshotBuffer && Buffer.isBuffer(screenshotBuffer) && screenshotBuffer.length > 0) {\n  result.binary = {\n    screenshot: {\n      data: screenshotBuffer,\n      mimeType: 'image/png',\n      fileName: config.screenshotFilename,\n      fileExtension: 'png'\n    }\n  };\n  console.log('âœ“âœ“âœ“ ë°”ì´ë„ˆë¦¬ ë°ì´í„° ì²¨ë¶€ ì™„ë£Œ (n8n í˜•ì‹):', screenshotBuffer.length, 'bytes');\n  console.log('âœ“ result.binary.screenshot.data íƒ€ì…:', typeof result.binary.screenshot.data);\n  console.log('âœ“ result.binary.screenshot.data Buffer?:', Buffer.isBuffer(result.binary.screenshot.data));\n  console.log('âœ“ fileName:', result.binary.screenshot.fileName);\n  console.log('âœ“ mimeType:', result.binary.screenshot.mimeType);\n} else {\n  console.error('âŒâŒâŒ ë°”ì´ë„ˆë¦¬ ë°ì´í„° ì—†ìŒ!');\n  if (screenshotBuffer) {\n    console.error('  - screenshotBuffer ì¡´ì¬í•˜ì§€ë§Œ ìœ íš¨í•˜ì§€ ì•ŠìŒ');\n    console.error('  - isBuffer:', Buffer.isBuffer(screenshotBuffer));\n    console.error('  - length:', screenshotBuffer.length);\n  }\n}\n\nconsole.log('=== ìµœì¢… ë°˜í™˜ê°’ êµ¬ì¡° ===');\nconsole.log('result.json:', Object.keys(result.json));\nconsole.log('result.binary:', result.binary ? Object.keys(result.binary) : 'undefined');\nconsole.log('=======================');\n\nreturn result;\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -64,
        -32
      ],
      "id": "8edaff45-33bd-4154-8764-92f356d3d130",
      "name": "Process AI Results & Extract Screenshot"
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://nhubmvsmsiovwbklzfvz.supabase.co/storage/v1/object/screenshots/{{ $json.config.screenshotFilename }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization"
            },
            {
              "name": "Content-Type",
              "value": "image/png"
            }
          ]
        },
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "screenshot",
        "options": {
          "response": {
            "response": {
              "responseFormat": "text"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        128,
        -32
      ],
      "id": "a21bec78-6403-420c-909b-e59d6a71cf62",
      "name": "Upload to Supabase",
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ì—…ë¡œë“œ ì„±ê³µ ì—¬ë¶€ ì²´í¬í•˜ê³  URL ì„¤ì •\nconst processData = $('Process AI Results & Extract Screenshot').first().json;\nconst uploadData = $json;\n\nlet screenshotUrl;\n\n// ì—ëŸ¬ê°€ ìˆê±°ë‚˜ ìŠ¤í¬ë¦°ìƒ·ì´ ì—†ìœ¼ë©´ Placeholder ì‚¬ìš©\nif (uploadData.error || !processData.hasScreenshot) {\n  console.log('âš  ìŠ¤í¬ë¦°ìƒ· ì—…ë¡œë“œ ì‹¤íŒ¨ ë˜ëŠ” ìŠ¤í¬ë¦°ìƒ· ì—†ìŒ - Placeholder ì‚¬ìš©');\n  screenshotUrl = 'https://via.placeholder.com/800x600.png?text=No+Screenshot+Available';\n} else {\n  console.log('âœ“ ìŠ¤í¬ë¦°ìƒ· ì—…ë¡œë“œ ì„±ê³µ');\n  screenshotUrl = `https://nhubmvsmsiovwbklzfvz.supabase.co/storage/v1/object/public/screenshots/${processData.config.screenshotFilename}`;\n}\n\nreturn {\n  json: {\n    ...processData,\n    screenshotUrl: screenshotUrl\n  }\n};"
      },
      "id": "4b9121c1-9b1c-4e2e-883c-9836c71fd33e",
      "name": "Set Screenshot URL",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        320,
        -32
      ]
    },
    {
      "parameters": {
        "jsCode": "// Teams ë©”ì‹œì§€ í¬ë§·íŒ… (ìˆ˜ì • ë²„ì „)\nconst processData = $('Process AI Results & Extract Screenshot').first().json;\nconst screenshotUrl = $json.screenshotUrl;\n\nconst summary = processData.summary;\nconst monitoringResult = processData.monitoringResult;\n\nconsole.log('=== Teams ë©”ì‹œì§€ í¬ë§·íŒ… ===');\nconsole.log('summary:', JSON.stringify(summary, null, 2));\n\n// ìƒíƒœ ì•„ì´ì½˜\nconst statusIcon = summary.status === 'success' ? 'âœ…' : \n                   summary.status === 'warning' ? 'âš ï¸' : 'âŒ';\nconst statusText = summary.status === 'success' ? 'ì •ìƒ' : \n                   summary.status === 'warning' ? 'ê²½ê³ ' : 'ì—ëŸ¬';\n\n// í˜ì´ì§€ ì œëª© (ì•ˆì „í•˜ê²Œ ì²˜ë¦¬)\nlet pageTitle = summary.pageTitle || monitoringResult.page_title || 'Fresh - ì‹ ì„ í•œ ì‹ì¬ë£Œë¥¼ ìƒˆë²½ê¹Œì§€';\n// ì œëª© ê¸¸ì´ ì œí•œ\nif (pageTitle.length > 100) {\n  pageTitle = pageTitle.substring(0, 97) + '...';\n}\nconsole.log('í˜ì´ì§€ ì œëª©:', pageTitle);\n\n// í˜ì´ì§€ ë¡œë“œ ì‹œê°„ (ì •í™•í•œ ê°’ ì‚¬ìš©)\nconst pageLoadTime = summary.pageLoadTime || monitoringResult.page_load_time_ms || 0;\nconsole.log('í˜ì´ì§€ ë¡œë“œ ì‹œê°„:', pageLoadTime, 'ms');\n\n// ì²´í¬ ì‹œê°„ í¬ë§·íŒ…: 2025.11.06 17:48:59\nconst date = new Date(summary.timestamp);\nconst year = date.getFullYear();\nconst month = String(date.getMonth() + 1).padStart(2, '0');\nconst day = String(date.getDate()).padStart(2, '0');\nconst hours = String(date.getHours()).padStart(2, '0');\nconst minutes = String(date.getMinutes()).padStart(2, '0');\nconst seconds = String(date.getSeconds()).padStart(2, '0');\nconst checkTime = `${year}.${month}.${day} ${hours}:${minutes}:${seconds}`;\nconsole.log('ì²´í¬ ì‹œê°„:', checkTime);\n\n// Teams Adaptive Card\nconst adaptiveCard = {\n  type: \"message\",\n  attachments: [\n    {\n      contentType: \"application/vnd.microsoft.card.adaptive\",\n      content: {\n        $schema: \"http://adaptivecards.io/schemas/adaptive-card.json\",\n        type: \"AdaptiveCard\",\n        version: \"1.5\",\n        body: [\n          {\n            type: \"Container\",\n            items: [\n              {\n                type: \"TextBlock\",\n                text: \"ğŸ¤– ì›¹ì‚¬ì´íŠ¸ í—¬ìŠ¤ ì²´í¬ ë¦¬í¬íŠ¸\",\n                size: \"Large\",\n                weight: \"Bolder\",\n                color: summary.status === 'success' ? 'Good' : 'Attention',\n                spacing: \"Medium\"\n              },\n              {\n                type: \"TextBlock\",\n                text: pageTitle,\n                weight: \"Bolder\",\n                wrap: true,\n                spacing: \"Small\",\n                size: \"Medium\"\n              }\n            ],\n            style: \"default\",\n            bleed: true\n          },\n          {\n            type: \"Container\",\n            items: [\n              {\n                type: \"FactSet\",\n                facts: [\n                  {\n                    title: \"URL\",\n                    value: summary.url\n                  },\n                  {\n                    title: \"ìƒíƒœ\",\n                    value: `${statusIcon} ${statusText}`\n                  },\n                  {\n                    title: \"HTTP ìƒíƒœ ì½”ë“œ\",\n                    value: summary.httpStatusCode.toString()\n                  },\n                  {\n                    title: \"í˜ì´ì§€ ë¡œë“œ ì‹œê°„\",\n                    value: `${pageLoadTime} ms`\n                  },\n                  {\n                    title: \"JavaScript ì—ëŸ¬\",\n                    value: `${summary.jsErrorCount}ê°œ`\n                  },\n                  {\n                    title: \"ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬\",\n                    value: `${summary.networkErrorCount}ê°œ`\n                  },\n                  {\n                    title: \"ì²´í¬ ì‹œê°„\",\n                    value: checkTime\n                  }\n                ]\n              }\n            ],\n            style: \"emphasis\",\n            bleed: true,\n            separator: true\n          },\n          {\n            type: \"Container\",\n            items: [\n              {\n                type: \"TextBlock\",\n                text: summary.status === 'success' ? \n                  'ğŸŸ¢ í˜„ì¬ ëª¨ë“  ì‹œìŠ¤í…œì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤.' : \n                  'ğŸ”´ AI Agentê°€ ë¬¸ì œë¥¼ ê°ì§€í–ˆìŠµë‹ˆë‹¤. í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.',\n                wrap: true,\n                color: summary.status === 'success' ? 'Good' : 'Attention',\n                weight: \"Bolder\",\n                spacing: \"Medium\"\n              }\n            ],\n            style: \"default\",\n            separator: true\n          },\n          {\n            type: \"Image\",\n            url: screenshotUrl,\n            size: \"Large\",\n            spacing: \"Medium\",\n            separator: true\n          },\n          {\n            type: \"TextBlock\",\n            text: \"âš™ï¸ AI Agentê°€ ì£¼ê¸°ì ìœ¼ë¡œ ì‚¬ì´íŠ¸ ìƒíƒœë¥¼ ëª¨ë‹ˆí„°ë§ ì¤‘ì…ë‹ˆë‹¤.\",\n            isSubtle: true,\n            wrap: true,\n            spacing: \"Medium\",\n            size: \"Small\"\n          }\n        ],\n        actions: [\n          {\n            type: \"Action.OpenUrl\",\n            title: \"ğŸ” ì‚¬ì´íŠ¸ ì—´ê¸°\",\n            url: summary.url\n          },\n          {\n            type: \"Action.OpenUrl\",\n            title: \"ğŸ“· ìŠ¤í¬ë¦°ìƒ· ì›ë³¸ ë³´ê¸°\",\n            url: screenshotUrl\n          }\n        ]\n      }\n    }\n  ]\n};\n\nreturn {\n  json: {\n    ...processData,\n    screenshotUrl: screenshotUrl,\n    teamsMessage: adaptiveCard\n  }\n};\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        512,
        -32
      ],
      "id": "1038c98b-da2a-40c3-a6f7-21a0f859e69f",
      "name": "Format Teams Message"
    },
    {
      "parameters": {
        "endpointUrl": "http://playwright-mcp:3001/sse",
        "serverTransport": "sse",
        "options": {
          "timeout": 60000
        }
      },
      "type": "@n8n/n8n-nodes-langchain.mcpClientTool",
      "typeVersion": 1.2,
      "position": [
        -176,
        224
      ],
      "id": "8f6b60d4-b34d-452e-b194-6316b289f808",
      "name": "Playwright MCP"
    },
    {
      "parameters": {
        "resource": "channelMessage",
        "teamId": {
          "__rl": true,
          "mode": "list",
          "value": ""
        },
        "channelId": {
          "__rl": true,
          "mode": "list",
          "value": ""
        },
        "options": {}
      },
      "type": "n8n-nodes-base.microsoftTeams",
      "typeVersion": 2,
      "position": [
        704,
        -32
      ],
      "id": "e474aca7-8554-41da-900a-f058f20ddaab",
      "name": "Create message",
      "webhookId": "5b0e49b3-3b03-4749-85e7-001b203ce960"
    }
  ],
  "pinData": {},
  "connections": {
    "Initialize Config": {
      "main": [
        [
          {
            "node": "Prepare Agent Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Agent Input": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Process AI Results & Extract Screenshot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Process AI Results & Extract Screenshot": {
      "main": [
        [
          {
            "node": "Upload to Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload to Supabase": {
      "main": [
        [
          {
            "node": "Set Screenshot URL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Screenshot URL": {
      "main": [
        [
          {
            "node": "Format Teams Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Teams Message": {
      "main": [
        [
          {
            "node": "Create message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Every 15 Minutes": {
      "main": [
        [
          {
            "node": "Initialize Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Playwright MCP": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "d00a924a-f464-4d48-8b43-0185de22dcd0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "b007e54dc68ebebfec657be46e7604ed5da78fee757d9916da8781555e4bd14e"
  },
  "id": "JyWU6bl9TXfVqaaR",
  "tags": []
}